<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BAML Generator v2.0 - Advanced Interface</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .step-complete {
            animation: slideInUp 0.3s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-shimmer {
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                üöÄ BAML Generator v2.0
            </h1>
            <p class="text-white/80 text-lg">
                Architecture Avanc√©e: SCoT + Cache S√©mantique + Streaming + Quality Enhancement
            </p>
        </div>

        <!-- Main Interface -->
        <div class="max-w-4xl mx-auto">
            <!-- Input Section -->
            <div class="glass-effect rounded-2xl p-6 mb-6">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        D√©crivez votre application
                    </label>
                    <textarea
                        id="prompt"
                        rows="6"
                        class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Exemple d√©taill√©:

Cr√©ez une marketplace de sneakers premium avec:
- Syst√®me de drops exclusifs avec countdown
- Authentification compl√®te (register/login/profile)
- Catalogue avec filtres avanc√©s (marque, taille, prix, condition)
- Panier avec sauvegarde et wishlist
- Syst√®me de notation et reviews avec photos
- Chat en temps r√©el entre acheteurs/vendeurs
- Tableau de bord vendeur avec analytics
- Payment Stripe int√©gr√©
- Design moderne responsive avec animations"
                    ></textarea>
                </div>

                <!-- Options avanc√©es -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="useCache" checked class="rounded">
                        <span class="text-sm text-gray-700">Cache S√©mantique</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="enhancePrompt" checked class="rounded">
                        <span class="text-sm text-gray-700">Am√©lioration SCoT</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="qualityCheck" checked class="rounded">
                        <span class="text-sm text-gray-700">V√©rification Qualit√©</span>
                    </label>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button
                        id="generateBtn"
                        onclick="generateAdvanced()"
                        class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105"
                    >
                        üöÄ G√©n√©rer avec IA Avanc√©e
                    </button>

                    <button
                        id="streamBtn"
                        onclick="generateStream()"
                        class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300"
                    >
                        üì° Mode Streaming SSE
                    </button>

                    <button
                        onclick="showCacheStats()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-xl transition-colors"
                    >
                        üìä Stats
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="glass-effect rounded-2xl p-6 mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        üìä Progression en Temps R√©el
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div class="pulse-dot w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">En cours</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
                    <div id="progressBar" class="progress-shimmer h-3 rounded-full" style="width: 0%"></div>
                </div>

                <!-- Steps Grid -->
                <div id="stepsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Steps will be populated here -->
                </div>

                <!-- Timer & Stats -->
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        ‚è±Ô∏è <span id="timer">0s</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        üéØ <span id="currentStep">Initialisation...</span>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="glass-effect rounded-2xl p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        ‚ú® R√©sultat G√©n√©ration
                    </h3>
                    <div id="qualityBadge" class="px-3 py-1 rounded-full text-sm font-medium">
                        <!-- Quality badge will be inserted here -->
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Cards will be populated -->
                </div>

                <!-- Detailed Results -->
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-medium text-gray-800 mb-2">üìã R√©sum√©</h4>
                        <div id="resultSummary" class="text-sm text-gray-600">
                            <!-- Summary will be inserted -->
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <h4 class="font-medium text-gray-800 mb-2">‚ö° Performances</h4>
                        <div id="performanceStats" class="text-sm text-gray-600">
                            <!-- Performance stats will be inserted -->
                        </div>
                    </div>

                    <!-- Raw JSON (collapsible) -->
                    <details class="bg-gray-50 rounded-xl p-4">
                        <summary class="font-medium text-gray-800 cursor-pointer">
                            üîç JSON Complet (Cliquez pour voir)
                        </summary>
                        <pre id="fullJson" class="mt-3 bg-gray-900 text-green-400 p-4 rounded-lg overflow-auto text-xs max-h-96">
                            <!-- Full JSON will be inserted -->
                        </pre>
                    </details>
                </div>

                <!-- Actions -->
                <div class="flex flex-wrap gap-3 mt-6">
                    <button onclick="downloadResult()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                        üíæ T√©l√©charger JSON
                    </button>
                    <button onclick="copyToClipboard()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                        üìã Copier
                    </button>
                    <button onclick="newGeneration()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                        ‚ú® Nouvelle G√©n√©ration
                    </button>
                </div>
            </div>

            <!-- Error Section -->
            <div id="errorSection" class="glass-effect rounded-2xl p-6 border-l-4 border-red-500 hidden">
                <div class="flex items-center mb-2">
                    <span class="text-2xl mr-2">‚ùå</span>
                    <h3 class="text-lg font-semibold text-red-800">Erreur de G√©n√©ration</h3>
                </div>
                <div id="errorMessage" class="text-red-700 mb-4">
                    <!-- Error message will be inserted -->
                </div>
                <button onclick="retryGeneration()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                    üîÑ R√©essayer
                </button>
            </div>

            <!-- Cache Stats Modal -->
            <div id="cacheModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
                <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">üìä Statistiques Cache</h3>
                        <button onclick="closeCacheModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                    </div>
                    <div id="cacheStatsContent">
                        <!-- Cache stats will be inserted -->
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button onclick="clearCache()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            üóëÔ∏è Vider Cache
                        </button>
                        <button onclick="closeCacheModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let currentResult = null;
        let startTime = null;
        let timerInterval = null;

        // Interface avanc√©e avec queue syst√®me
        async function generateAdvanced() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('Veuillez entrer une description');
                return;
            }

            showProgress();
            startTimer();

            try {
                // Utiliser l'API queue pour g√©n√©ration asynchrone
                const response = await fetch(`${API_BASE}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt,
                        metadata: {
                            source: 'web-advanced',
                            options: getOptions()
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Polling de progression
                    pollJobStatus(data.jobId);
                } else {
                    throw new Error(data.error);
                }

            } catch (error) {
                showError(error.message);
                stopTimer();
            }
        }

        // Streaming SSE avec toutes les optimisations
        async function generateStream() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                alert('Veuillez entrer une description');
                return;
            }

            showProgress();
            startTimer();

            try {
                const response = await fetch(`${API_BASE}/api/generate/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt,
                        useCache: document.getElementById('useCache').checked,
                        enhancePrompt: document.getElementById('enhancePrompt').checked
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                stopTimer();
                                return;
                            }

                            try {
                                const parsed = JSON.parse(data);
                                handleStreamData(parsed);
                            } catch (e) {
                                console.warn('Parse error:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                showError(error.message);
                stopTimer();
            }
        }

        // Polling pour suivi du job
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`${API_BASE}/api/status/${jobId}`);
                const job = await response.json();

                updateProgressFromJob(job);

                if (job.status === 'completed') {
                    const result = await fetch(`${API_BASE}/api/result/${jobId}`);
                    const data = await result.json();
                    showResults(data.result, data);
                    stopTimer();
                } else if (job.status === 'failed') {
                    showError(job.error || 'G√©n√©ration √©chou√©e');
                    stopTimer();
                } else {
                    // Continuer le polling
                    setTimeout(() => pollJobStatus(jobId), 1000);
                }

            } catch (error) {
                console.error('Polling error:', error);
                setTimeout(() => pollJobStatus(jobId), 2000);
            }
        }

        // G√©rer les donn√©es de streaming
        function handleStreamData(data) {
            switch (data.type) {
                case 'step':
                    updateStep(data.step, data.message, 'processing');
                    break;

                case 'progress':
                    updateProgressBar(data.progress || 0);
                    if (data.preview) {
                        updateCurrentStep(`Streaming: ${data.preview.slice(-50)}...`);
                    }
                    break;

                case 'complete':
                    showResults(data.result, data);
                    break;

                case 'error':
                    showError(data.error);
                    break;
            }
        }

        // Mise √† jour progression depuis job
        function updateProgressFromJob(job) {
            updateProgressBar(job.progress || 0);

            if (job.steps && job.steps.length > 0) {
                job.steps.forEach(step => {
                    updateStep(step, 'Termin√©', 'complete');
                });
            }

            updateCurrentStep(`Status: ${job.status}`);
        }

        // Affichage des r√©sultats avanc√©s
        function showResults(result, metadata = {}) {
            currentResult = result;

            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            // Badge qualit√©
            const qualityScore = metadata.qualityScore || 10;
            const badge = document.getElementById('qualityBadge');
            badge.className = `px-3 py-1 rounded-full text-sm font-medium ${
                qualityScore >= 9 ? 'bg-green-100 text-green-800' :
                qualityScore >= 7 ? 'bg-yellow-100 text-yellow-800' :
                'bg-red-100 text-red-800'
            }`;
            badge.textContent = `Qualit√©: ${qualityScore}/10`;

            // Cards r√©sum√©
            const cards = [
                { label: 'Pages', value: result.pages?.length || 0, icon: 'üìÑ' },
                { label: 'Composants', value: result.components?.length || 0, icon: 'üß©' },
                { label: 'API Routes', value: result.apiRoutes?.length || 0, icon: 'üîå' },
                { label: 'Images', value: Object.keys(result.images || {}).length, icon: 'üñºÔ∏è' }
            ];

            document.getElementById('summaryCards').innerHTML = cards.map(card => `
                <div class="bg-white rounded-lg p-3 text-center">
                    <div class="text-2xl mb-1">${card.icon}</div>
                    <div class="text-lg font-semibold">${card.value}</div>
                    <div class="text-xs text-gray-600">${card.label}</div>
                </div>
            `).join('');

            // R√©sum√©
            document.getElementById('resultSummary').innerHTML = `
                <div><strong>Nom:</strong> ${result.name || 'N/A'}</div>
                <div><strong>Type:</strong> ${result.projectType || 'N/A'}</div>
                <div><strong>Description:</strong> ${result.description || 'Application g√©n√©r√©e'}</div>
                ${metadata.cached ? '<div class="text-blue-600"><strong>üéØ R√©sultat du cache</strong></div>' : ''}
            `;

            // Stats performance
            document.getElementById('performanceStats').innerHTML = `
                <div><strong>‚è±Ô∏è Temps de traitement:</strong> ${metadata.processingTime || 0}ms</div>
                <div><strong>üìä Score qualit√©:</strong> ${qualityScore}/10</div>
                <div><strong>üîß Am√©liorations:</strong> ${metadata.improvements?.length || 0}</div>
                <div><strong>üíæ Mise en cache:</strong> ${metadata.cached ? 'Oui' : 'Non'}</div>
            `;

            // JSON complet
            document.getElementById('fullJson').textContent = JSON.stringify(result, null, 2);

            // R√©activer le bouton
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('streamBtn').disabled = false;
        }

        // Fonctions utilitaires
        function showProgress() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');

            // Reset progress
            updateProgressBar(0);
            document.getElementById('stepsContainer').innerHTML = '';

            // D√©sactiver boutons
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('streamBtn').disabled = true;
        }

        function updateProgressBar(percentage) {
            const bar = document.getElementById('progressBar');
            bar.style.width = percentage + '%';
        }

        function updateStep(stepName, message, status = 'processing') {
            const container = document.getElementById('stepsContainer');
            let stepElement = document.getElementById(`step-${stepName}`);

            if (!stepElement) {
                stepElement = document.createElement('div');
                stepElement.id = `step-${stepName}`;
                stepElement.className = 'flex items-center space-x-3 p-3 bg-white rounded-lg step-complete';
                container.appendChild(stepElement);
            }

            const icons = {
                processing: '‚è≥',
                complete: '‚úÖ',
                error: '‚ùå'
            };

            const colors = {
                processing: 'text-orange-600',
                complete: 'text-green-600',
                error: 'text-red-600'
            };

            stepElement.innerHTML = `
                <span class="text-lg">${icons[status]}</span>
                <div class="flex-1">
                    <div class="font-medium ${colors[status]}">${stepName}</div>
                    <div class="text-sm text-gray-600">${message}</div>
                </div>
            `;
        }

        function updateCurrentStep(step) {
            document.getElementById('currentStep').textContent = step;
        }

        function showError(message) {
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');

            document.getElementById('errorMessage').textContent = message;

            // R√©activer boutons
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('streamBtn').disabled = false;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function getOptions() {
            return {
                useCache: document.getElementById('useCache').checked,
                enhancePrompt: document.getElementById('enhancePrompt').checked,
                qualityCheck: document.getElementById('qualityCheck').checked
            };
        }

        // Actions utilitaires
        function downloadResult() {
            if (!currentResult) return;

            const blob = new Blob([JSON.stringify(currentResult, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentResult.name || 'generated-app'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if (!currentResult) return;

            navigator.clipboard.writeText(JSON.stringify(currentResult, null, 2))
                .then(() => alert('üìã R√©sultat copi√© dans le presse-papier'))
                .catch(() => alert('‚ùå Erreur lors de la copie'));
        }

        function newGeneration() {
            document.getElementById('prompt').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            currentResult = null;
        }

        function retryGeneration() {
            generateAdvanced();
        }

        // Stats cache
        async function showCacheStats() {
            try {
                const response = await fetch(`${API_BASE}/api/generate/route`);
                const data = await response.json();

                document.getElementById('cacheStatsContent').innerHTML = `
                    <div class="space-y-3 text-sm">
                        <div><strong>Taille du cache:</strong> ${data.cache.stats.size}</div>
                        <div><strong>Total hits:</strong> ${data.cache.stats.totalHits}</div>
                        <div><strong>Taux de hit moyen:</strong> ${data.cache.stats.avgHits}</div>
                        <div><strong>Entr√©e la plus ancienne:</strong> ${data.cache.stats.oldestEntry || 'Aucune'}</div>
                        <div><strong>Entr√©e la plus r√©cente:</strong> ${data.cache.stats.newestEntry || 'Aucune'}</div>
                        <div><strong>Serveur uptime:</strong> ${Math.floor(data.cache.serverUptime)}s</div>
                    </div>
                `;

                document.getElementById('cacheModal').classList.remove('hidden');
                document.getElementById('cacheModal').classList.add('flex');

            } catch (error) {
                alert('Erreur lors de la r√©cup√©ration des stats: ' + error.message);
            }
        }

        function closeCacheModal() {
            document.getElementById('cacheModal').classList.add('hidden');
            document.getElementById('cacheModal').classList.remove('flex');
        }

        async function clearCache() {
            if (!confirm('√ätes-vous s√ªr de vouloir vider le cache ?')) return;

            try {
                // API call to clear cache would go here
                alert('üóëÔ∏è Cache vid√© avec succ√®s');
                closeCacheModal();
            } catch (error) {
                alert('Erreur lors du vidage du cache: ' + error.message);
            }
        }
    </script>
</body>
</html>